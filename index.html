<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ultimate Code Editor Pro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --sidebar-width: 300px;
      --preview-width: 400px;
      --header-height: 40px;
      --tab-height: 35px;
      --primary: #1e1e1e;
      --secondary: #252526;
      --accent: #007acc;
      --text: #d4d4d4;
      --border: #3c3c3c;
      --error: #f48771;
      --warning: #ffcc00;
      --success: #4caf50;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--primary);
      color: var(--text);
      overflow: hidden;
    }

    .header {
      height: var(--header-height);
      background: var(--secondary);
      display: flex;
      align-items: center;
      padding: 0 15px;
      -webkit-app-region: drag;
      border-bottom: 1px solid var(--border);
    }

    .title {
      font-size: 14px;
      opacity: 0.8;
      display: flex;
      align-items: center;
    }

    .title i {
      margin-right: 8px;
      color: var(--accent);
    }

    .window-controls {
      display: flex;
      margin-left: auto;
      -webkit-app-region: no-drag;
    }

    .window-btn {
      width: 46px;
      height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .window-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    .window-btn.close:hover {
      background: #e81123;
    }

    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--secondary);
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      transition: width 0.3s ease;
    }

    .sidebar-header {
      padding: 10px 15px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.7;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-actions {
      display: flex;
    }

    .sidebar-btn {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 5px;
      transition: background 0.2s;
      opacity: 0.7;
    }

    .sidebar-btn:hover {
      background: rgba(255,255,255,0.1);
      opacity: 1;
    }

    .file-tree {
      flex: 1;
      overflow-y: auto;
      padding: 5px 0;
    }

    .file-item {
      padding: 6px 15px 6px 30px;
      font-size: 13px;
      cursor: pointer;
      position: relative;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
    }

    .file-item:hover {
      background: rgba(255,255,255,0.05);
    }

    .file-item.active {
      background: rgba(0,122,204,0.2);
    }

    .file-item i {
      margin-right: 8px;
      width: 16px;
      text-align: center;
      font-size: 14px;
    }

    /* Editor */
    .editor-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .tab-bar {
      height: var(--tab-height);
      background: var(--secondary);
      display: flex;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      scrollbar-width: none;
    }

    .tab-bar::-webkit-scrollbar {
      display: none;
    }

    .tab {
      padding: 0 15px;
      display: flex;
      align-items: center;
      font-size: 13px;
      cursor: pointer;
      border-right: 1px solid var(--border);
      position: relative;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .tab i {
      margin-right: 8px;
      font-size: 14px;
    }

    .tab.active {
      background: var(--primary);
      color: var(--accent);
    }

    .tab.active:after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }

    .tab-close {
      margin-left: 8px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .tab:hover .tab-close {
      opacity: 1;
    }

    .editor-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .CodeMirror {
      height: 100% !important;
      font-size: 14px;
      line-height: 1.6;
      font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
    }

    /* Preview */
    .preview-area {
      width: var(--preview-width);
      display: flex;
      flex-direction: column;
      background: white;
      border-left: 1px solid var(--border);
      transition: width 0.3s ease;
    }

    .preview-header {
      height: var(--tab-height);
      background: var(--secondary);
      display: flex;
      align-items: center;
      padding: 0 15px;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }

    .preview-actions {
      margin-left: auto;
      display: flex;
    }

    .preview-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 5px;
      transition: all 0.2s ease;
    }

    .preview-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    #preview {
      flex: 1;
      border: none;
      background: white;
    }

    /* Resizers */
    .resizer {
      width: 5px;
      background: var(--border);
      cursor: col-resize;
      transition: background 0.2s;
      position: relative;
      z-index: 10;
    }

    .resizer:hover {
      background: var(--accent);
    }

    /* Status bar */
    .status-bar {
      height: 22px;
      background: var(--secondary);
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-size: 11px;
      border-top: 1px solid var(--border);
    }

    .status-item {
      margin-right: 15px;
      display: flex;
      align-items: center;
    }

    .status-item i {
      margin-right: 5px;
      font-size: 10px;
    }

    /* Highlight line */
    .CodeMirror-linebackground.highlighted-line {
      background-color: rgba(0, 122, 204, 0.3);
      transition: background-color 0.3s ease;
    }

    /* Tooltip */
    .tooltip {
      position: absolute;
      background: var(--secondary);
      color: var(--text);
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tooltip.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Element highlight in preview */
    .element-highlight {
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
      animation: highlight-pulse 1.5s ease-in-out infinite;
      position: relative;
    }

    @keyframes highlight-pulse {
      0% { outline-color: var(--accent); }
      50% { outline-color: #00a8ff; }
      100% { outline-color: var(--accent); }
    }

    /* Context menu */
    .context-menu {
      position: absolute;
      background: var(--secondary);
      border: 1px solid var(--border);
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1001;
      min-width: 180px;
      display: none;
    }

    .context-menu.show {
      display: block;
    }

    .context-item {
      padding: 8px 15px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background 0.2s;
    }

    .context-item:hover {
      background: rgba(255,255,255,0.1);
    }

    .context-item i {
      margin-right: 8px;
      width: 16px;
      text-align: center;
    }

    .context-separator {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }

    /* Notifications */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--secondary);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      z-index: 1002;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 300px;
    }

    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .notification i {
      margin-right: 10px;
      font-size: 16px;
    }

    .notification.success {
      border-left: 3px solid var(--success);
    }

    .notification.error {
      border-left: 3px solid var(--error);
    }

    .notification.warning {
      border-left: 3px solid var(--warning);
    }

    /* Search box */
    .search-box {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--secondary);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 5px;
      z-index: 100;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: none;
    }

    .search-box.show {
      display: flex;
    }

    .search-input {
      background: transparent;
      border: none;
      color: var(--text);
      padding: 5px;
      width: 200px;
      outline: none;
    }

    .search-count {
      font-size: 11px;
      margin: 0 5px;
      opacity: 0.7;
    }

    .search-btn {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 5px;
      transition: background 0.2s;
    }

    .search-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    /* Loading indicator */
    .loading-indicator {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: transparent;
      z-index: 1000;
      overflow: hidden;
      display: none;
    }

    .loading-indicator.active {
      display: block;
    }

    .loading-indicator::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 50%;
      background: var(--accent);
      animation: loading 1.5s ease-in-out infinite;
    }

    @keyframes loading {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(200%); }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">
      <i class="fas fa-code"></i>
      <span>Ultimate Code Editor Pro</span>
    </div>
    <div class="window-controls">
      <div class="window-btn" id="minimize-btn">
        <i class="fas fa-minus"></i>
      </div>
      <div class="window-btn" id="maximize-btn">
        <i class="fas fa-square"></i>
      </div>
      <div class="window-btn close" id="close-btn">
        <i class="fas fa-times"></i>
      </div>
    </div>
  </div>

  <div class="loading-indicator" id="loading-indicator"></div>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <i class="fas fa-folder-open"></i>
        <span>Project Files</span>
        <div class="sidebar-actions">
          <div class="sidebar-btn" id="new-file-btn" title="New File">
            <i class="fas fa-file"></i>
          </div>
          <div class="sidebar-btn" id="refresh-files-btn" title="Refresh">
            <i class="fas fa-sync-alt"></i>
          </div>
        </div>
      </div>
      <div class="file-tree" id="file-tree">
        <div class="file-item active" data-file="html">
          <i class="fab fa-html5"></i>
          index.html
        </div>
        <div class="file-item" data-file="css">
          <i class="fab fa-css3-alt"></i>
          style.css
        </div>
        <div class="file-item" data-file="js">
          <i class="fab fa-js-square"></i>
          script.js
        </div>
      </div>
    </div>

    <div class="resizer" id="sidebar-resizer"></div>

    <!-- Editor Area -->
    <div class="editor-area">
      <div class="tab-bar">
        <div class="tab active" data-tab="html">
          <i class="fab fa-html5"></i>
          <span>index.html</span>
          <i class="fas fa-times tab-close"></i>
        </div>
        <div class="tab" data-tab="css">
          <i class="fab fa-css3-alt"></i>
          <span>style.css</span>
          <i class="fas fa-times tab-close"></i>
        </div>
        <div class="tab" data-tab="js">
          <i class="fab fa-js-square"></i>
          <span>script.js</span>
          <i class="fas fa-times tab-close"></i>
        </div>
      </div>
      
      <div class="editor-container">
        <div id="code-editor"></div>
        <div class="search-box" id="search-box">
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
          <div class="search-count" id="search-count">0/0</div>
          <div class="search-btn" id="search-prev" title="Previous">
            <i class="fas fa-chevron-up"></i>
          </div>
          <div class="search-btn" id="search-next" title="Next">
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="search-btn" id="search-close" title="Close">
            <i class="fas fa-times"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="resizer" id="preview-resizer"></div>

    <!-- Preview Area -->
    <div class="preview-area" id="preview-panel">
      <div class="preview-header">
        <i class="fas fa-eye"></i>
        <span>Live Preview</span>
        <div class="preview-actions">
          <div class="preview-btn" id="refresh-preview" title="Refresh">
            <i class="fas fa-sync-alt"></i>
          </div>
          <div class="preview-btn" id="expand-preview" title="Toggle Full Width">
            <i class="fas fa-expand"></i>
          </div>
          <div class="preview-btn" id="toggle-preview" title="Toggle Preview">
            <i class="fas fa-eye-slash"></i>
          </div>
        </div>
      </div>
      <iframe id="preview"></iframe>
    </div>
  </div>

  <div class="status-bar">
    <div class="status-item">
      <i class="fas fa-code"></i>
      <span>HTML</span>
    </div>
    <div class="status-item">
      <i class="fas fa-file-code"></i>
      <span>Unsaved</span>
    </div>
    <div class="status-item" id="cursor-position">
      <i class="fas fa-arrows-alt"></i>
      <span>Ln 1, Col 1</span>
    </div>
    <div class="status-item" id="file-size">
      <i class="fas fa-database"></i>
      <span>0 KB</span>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <div class="context-menu" id="context-menu">
    <div class="context-item" id="ctx-copy">
      <i class="fas fa-copy"></i>
      <span>Copy</span>
    </div>
    <div class="context-item" id="ctx-paste">
      <i class="fas fa-paste"></i>
      <span>Paste</span>
    </div>
    <div class="context-separator"></div>
    <div class="context-item" id="ctx-format">
      <i class="fas fa-indent"></i>
      <span>Format Code</span>
    </div>
    <div class="context-separator"></div>
    <div class="context-item" id="ctx-search">
      <i class="fas fa-search"></i>
      <span>Search</span>
    </div>
  </div>

  <div class="notification" id="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notification-message">Operation completed successfully</span>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/comment/comment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/display/autorefresh.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">

  <script>
    // Инициализация редактора
    const editorContainer = document.getElementById('code-editor');
    let currentEditor = null;
    const editors = {};
    let currentMode = 'html';
    let lastHighlightedElement = null;
    let searchQuery = null;
    let searchCursor = null;
    let searchIndex = 0;
    let searchMatches = [];
    
    // Исходный код для каждого типа
    const initialCode = {
      html: `<!DOCTYPE html>
<html>
<head>
  <title>My Page</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Welcome to Ultimate Editor Pro!</h1>
  <p>Edit the code and see changes in real-time.</p>
  <button id="demo-btn">Click Me</button>
  <div class="container">
    <div class="box">Box 1</div>
    <div class="box">Box 2</div>
    <div class="box">Box 3</div>
  </div>
  
  <script src="script.js"><\/script>
</body>
</html>`,
      css: `body {
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  padding: 20px;
  background: #f5f7fa;
  color: #333;
}

h1 {
  color: #007acc;
  margin-bottom: 20px;
}

button {
  background: #007acc;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
}

button:hover {
  background: #0062a3;
}

.container {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.box {
  padding: 15px;
  background: #007acc;
  color: white;
  border-radius: 4px;
}`,
      js: `console.log('Hello from Ultimate Editor Pro!');

document.getElementById('demo-btn').addEventListener('click', function() {
  alert('Button clicked!');
});

// Box hover effect
document.querySelectorAll('.box').forEach(box => {
  box.addEventListener('mouseover', function() {
    this.style.transform = 'scale(1.05)';
    this.style.transition = 'transform 0.3s ease';
  });
  
  box.addEventListener('mouseout', function() {
    this.style.transform = 'scale(1)';
  });
});`
    };

    // Создаем редактор для текущего режима
    function createEditor(mode) {
      // Если редактор уже существует, просто возвращаем его
      if (editors[mode]) {
        return editors[mode];
      }
      
      const config = {
        mode: mode === 'html' ? 'htmlmixed' : mode,
        theme: 'dracula',
        lineNumbers: true,
        value: initialCode[mode],
        indentUnit: 2,
        tabSize: 2,
        lineWrapping: true,
        autoCloseTags: mode === 'html',
        autoCloseBrackets: true,
        matchBrackets: true,
        extraKeys: {
          'Ctrl-Enter': function(cm) {
            updatePreview();
          },
          'Ctrl-/': function(cm) {
            cm.toggleComment();
          },
          'Ctrl-S': function(cm) {
            saveFile();
          },
          'Ctrl-F': function(cm) {
            toggleSearch();
          },
          'F3': function(cm) {
            findNext();
          },
          'Shift-F3': function(cm) {
            findPrev();
          },
          'Ctrl-Alt-F': function(cm) {
            cm.replaceAll = !cm.replaceAll;
          },
          'Ctrl-Alt-L': function(cm) {
            formatCode();
          }
        },
        autoRefresh: true
      };
      
      // Создаем новый редактор
      const editor = CodeMirror(editorContainer, config);
      editors[mode] = editor;
      
      // Обработчик изменений
      editor.on('change', function() {
        updatePreview();
        updateFileSize();
      });
      
      // Обновление позиции курсора
      editor.on('cursorActivity', updateCursorPosition);
      
      // Контекстное меню
      editor.on('contextmenu', function(cm, e) {
        showContextMenu(e);
        return false;
      });
      
      // Обновляем размер файла при инициализации
      updateFileSize();
      
      // Скрываем редактор, если он не активный
      if (mode !== currentMode) {
        editor.getWrapperElement().style.display = 'none';
      }
      
      return editor;
    }

    // Обновление позиции курсора в статус баре
    function updateCursorPosition() {
      if (!currentEditor) return;
      const cursor = currentEditor.getCursor();
      document.getElementById('cursor-position').querySelector('span').textContent = 
        `Ln ${cursor.line + 1}, Col ${cursor.ch + 1}`;
    }

    // Обновление размера файла
    function updateFileSize() {
      if (!currentEditor) return;
      const content = currentEditor.getValue();
      const size = new Blob([content]).size;
      const kb = (size / 1024).toFixed(2);
      document.getElementById('file-size').querySelector('span').textContent = `${kb} KB`;
    }

    // Переключение между редакторами
    function switchEditor(mode) {
      // Если уже в этом режиме, ничего не делаем
      if (currentMode === mode && editors[mode]) return;
      
      // Скрываем текущий редактор
      if (currentEditor) {
        currentEditor.getWrapperElement().style.display = 'none';
      }
      
      // Получаем или создаем новый редактор
      currentEditor = editors[mode] || createEditor(mode);
      currentMode = mode;
      
      // Показываем новый редактор
      currentEditor.getWrapperElement().style.display = '';
      currentEditor.refresh();
      
      // Обновляем статус бар
      const statusItem = document.querySelector('.status-item span');
      statusItem.textContent = mode.toUpperCase();
      
      // Обновляем позицию курсора
      updateCursorPosition();
      updateFileSize();
      
      // Обновляем превью
      updatePreview();
    }

    // Превью
    const preview = document.getElementById('preview');
    let isPreviewRefreshing = false;

    function updatePreview() {
      if (isPreviewRefreshing) return;
      
      isPreviewRefreshing = true;
      showLoading(true);
      
      setTimeout(() => {
        try {
          const html = editors.html ? editors.html.getValue() : initialCode.html;
          const css = editors.css ? editors.css.getValue() : initialCode.css;
          const js = editors.js ? editors.js.getValue() : initialCode.js;
          
          const previewDoc = preview.contentDocument || preview.contentWindow.document;
          
          previewDoc.open();
          previewDoc.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                .loading {
                  position: fixed;
                  top: 0;
                  left: 0;
                  right: 0;
                  bottom: 0;
                  background: white;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  z-index: 1000;
                  animation: fadeOut 0.5s 0.5s forwards;
                }
                .spinner {
                  width: 40px;
                  height: 40px;
                  border: 4px solid #f3f3f3;
                  border-top: 4px solid #007acc;
                  border-radius: 50%;
                  animation: spin 1s linear infinite;
                }
                @keyframes spin {
                  0% { transform: rotate(0deg); }
                  100% { transform: rotate(360deg); }
                }
                @keyframes fadeOut {
                  to { opacity: 0; visibility: hidden; }
                }
                * {
                  cursor: pointer !important;
                }
                ${css}
              </style>
            </head>
            <body>
              <div class="loading">
                <div class="spinner"></div>
              </div>
              ${html}
              <script>
                // Инспектор элементов
                document.addEventListener('click', function(e) {
                  if (e.button === 0) { // Левая кнопка мыши
                    const element = e.target;
                    
                    // Удаляем предыдущее выделение
                    const prevHighlight = document.querySelector('.element-highlight');
                    if (prevHighlight) {
                      prevHighlight.classList.remove('element-highlight');
                    }
                    
                    // Добавляем выделение текущему элементу
                    element.classList.add('element-highlight');
                    
                    // Получаем путь к элементу
                    const path = [];
                    let current = element;
                    while (current && current !== document.body) {
                      let selector = current.tagName.toLowerCase();
                      
                      if (current.id) {
                        selector += '#' + current.id;
                        path.unshift(selector);
                        break;
                      } else {
                        let sibling = current;
                        let nth = 1;
                        while (sibling = sibling.previousElementSibling) {
                          if (sibling.nodeName === current.nodeName) nth++;
                        }
                        if (nth !== 1) selector += ':nth-of-type(' + nth + ')';
                      }
                      
                      path.unshift(selector);
                      current = current.parentNode;
                    }
                    
                    // Отправляем данные в редактор
                    window.parent.postMessage({
                      type: 'inspectElement',
                      tagName: element.tagName,
                      id: element.id,
                      className: element.className,
                      innerText: element.innerText.trim().substring(0, 50),
                      x: e.clientX,
                      y: e.clientY,
                      path: path.join(' > ')
                    }, '*');
                    
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                  }
                }, true);
                
                ${js}
              <\/script>
            </body>
            </html>
          `);
          previewDoc.close();
        } catch (e) {
          console.error('Error updating preview:', e);
        } finally {
          isPreviewRefreshing = false;
          showLoading(false);
        }
      }, 100);
    }

    // Показать/скрыть индикатор загрузки
    function showLoading(show) {
      const indicator = document.getElementById('loading-indicator');
      if (show) {
        indicator.classList.add('active');
      } else {
        indicator.classList.remove('active');
      }
    }

    // Обработчик сообщений из iframe
    window.addEventListener('message', function(event) {
      if (event.data.type === 'inspectElement') {
        inspectElement(event.data);
      }
    });

    // Инспектор элементов
    function inspectElement(elementData) {
      // Переключаемся на HTML редактор
      switchEditor('html');
      
      const htmlCode = editors.html.getValue();
      const lines = htmlCode.split('\n');
      let foundLine = -1;
      
      // Создаем более точные шаблоны для поиска
      const searchPatterns = [];
      
      // 1. Точный поиск по ID (если есть)
      if (elementData.id) {
        searchPatterns.push(new RegExp(`<${elementData.tagName}[^>]*id=["']${elementData.id}["'][^>]*>`, 'i'));
      }
      
      // 2. Поиск по классам (точное совпадение)
      if (elementData.className) {
        const classes = elementData.className.split(/\s+/).filter(c => c);
        if (classes.length) {
          const classRegex = classes.map(c => `(?=.*${c})`).join('');
          searchPatterns.push(new RegExp(`<${elementData.tagName}[^>]*class=["'][^"']*${classRegex}[^"']*["'][^>]*>`, 'i'));
        }
      }
      
      // 3. Поиск по тегу с учетом возможных атрибутов
      searchPatterns.push(new RegExp(`<${elementData.tagName}[^>]*>`, 'i'));
      
      // 4. Поиск по тексту (если есть)
      if (elementData.innerText) {
        const text = elementData.innerText.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
        searchPatterns.push(new RegExp(text));
      }
      
      // 5. Поиск по пути (если есть)
      if (elementData.path) {
        const pathParts = elementData.path.split(' > ');
        const lastPart = pathParts[pathParts.length - 1];
        searchPatterns.push(new RegExp(lastPart));
      }
      
      // Ищем элемент в коде (с конца, чтобы найти последнее вхождение)
      for (let i = lines.length - 1; i >= 0; i--) {
        for (const pattern of searchPatterns) {
          if (pattern.test(lines[i])) {
            foundLine = i;
            break;
          }
        }
        if (foundLine !== -1) break;
      }
      
      if (foundLine !== -1) {
        // Прокручиваем редактор к этой строке и устанавливаем курсор
        editors.html.setCursor({line: foundLine, ch: 0});
        editors.html.focus();
        
        // Подсвечиваем строку
        editors.html.addLineClass(foundLine, 'background', 'highlighted-line');
        setTimeout(() => {
          editors.html.removeLineClass(foundLine, 'background', 'highlighted-line');
        }, 2000);
        
        // Показываем подсказку
        showTooltip(
          `Found: ${elementData.tagName.toLowerCase()}` + 
          `${elementData.id ? '#' + elementData.id : ''}` + 
          `${elementData.className ? '.' + elementData.className.replace(/\s+/g, '.') : ''}`,
          foundLine
        );
        
        // Показываем уведомление
        showNotification(`Element found at line ${foundLine + 1}`, 'success');
      } else {
        showTooltip('Element not found in HTML code', 0);
        showNotification('Element not found in code', 'error');
      }
    }

    // Показать подсказку
    function showTooltip(message, line) {
      const tooltip = document.getElementById('tooltip');
      tooltip.textContent = message;
      
      if (editors.html) {
        const coords = editors.html.charCoords({line: line, ch: 0}, 'local');
        tooltip.style.left = (coords.left + 20) + 'px';
        tooltip.style.top = (coords.top - 30) + 'px';
      } else {
        tooltip.style.left = '20px';
        tooltip.style.top = '60px';
      }
      
      tooltip.classList.add('show');
      setTimeout(() => {
        tooltip.classList.remove('show');
      }, 2000);
    }

    // Показать уведомление
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      const notificationMsg = document.getElementById('notification-message');
      
      notification.className = 'notification ' + type;
      notificationMsg.textContent = message;
      
      // Установка иконки в зависимости от типа
      const icon = notification.querySelector('i');
      if (type === 'success') {
        icon.className = 'fas fa-check-circle';
      } else if (type === 'error') {
        icon.className = 'fas fa-exclamation-circle';
      } else if (type === 'warning') {
        icon.className = 'fas fa-exclamation-triangle';
      }
      
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Показать контекстное меню
    function showContextMenu(e) {
      const contextMenu = document.getElementById('context-menu');
      contextMenu.style.left = e.clientX + 'px';
      contextMenu.style.top = e.clientY + 'px';
      contextMenu.classList.add('show');
      
      // Закрытие меню при клике вне его
      const closeMenu = function() {
        contextMenu.classList.remove('show');
        document.removeEventListener('click', closeMenu);
      };
      
      setTimeout(() => {
        document.addEventListener('click', closeMenu);
      }, 100);
    }

    // Поиск в редакторе
    function toggleSearch() {
      const searchBox = document.getElementById('search-box');
      searchBox.classList.toggle('show');
      
      if (searchBox.classList.contains('show')) {
        document.getElementById('search-input').focus();
      }
    }

    function findText(query, reverse) {
      if (!currentEditor) return;
      
      searchQuery = query;
      if (!searchQuery) return;
      
      searchCursor = currentEditor.getSearchCursor(searchQuery);
      searchMatches = [];
      
      // Находим все совпадения
      while (searchCursor.findNext()) {
        searchMatches.push({
          from: searchCursor.from(),
          to: searchCursor.to()
        });
      }
      
      if (searchMatches.length > 0) {
        searchIndex = reverse ? searchMatches.length - 1 : 0;
        highlightSearchResult();
      } else {
        showNotification('No matches found', 'warning');
      }
    }

    function highlightSearchResult() {
      if (!currentEditor || !searchMatches || searchMatches.length === 0) return;
      
      const match = searchMatches[searchIndex];
      currentEditor.setSelection(match.from, match.to);
      currentEditor.scrollIntoView(match.from, 50);
      
      // Обновляем счетчик
      document.getElementById('search-count').textContent = 
        `${searchIndex + 1}/${searchMatches.length}`;
    }

    function findNext() {
      if (!searchMatches || searchMatches.length === 0) return;
      
      searchIndex = (searchIndex + 1) % searchMatches.length;
      highlightSearchResult();
    }

    function findPrev() {
      if (!searchMatches || searchMatches.length === 0) return;
      
      searchIndex = (searchIndex - 1 + searchMatches.length) % searchMatches.length;
      highlightSearchResult();
    }

    // Форматирование кода
    function formatCode() {
      if (!currentEditor) return;
      
      const code = currentEditor.getValue();
      let formatted = code;
      
      try {
        if (currentMode === 'html') {
          // Простое форматирование отступов для HTML
          let indent = 0;
          formatted = code.replace(/<(\/?)([^>]+)>/g, function(match, slash, tag) {
            if (slash) {
              indent--;
              return '\n' + '  '.repeat(indent) + match;
            } else if (tag.match(/\/$/)) {
              return '\n' + '  '.repeat(indent) + match;
            } else {
              const result = '\n' + '  '.repeat(indent) + match;
              indent++;
              return result;
            }
          }).trim();
        } else if (currentMode === 'css') {
          // Форматирование CSS
          formatted = code
            .replace(/\s*\{\s*/g, ' {\n  ')
            .replace(/\s*\}\s*/g, '\n}\n\n')
            .replace(/\s*;\s*/g, ';\n  ')
            .replace(/\s*,\s*/g, ', ')
            .replace(/\n\s*\n/g, '\n');
        } else if (currentMode === 'js') {
          // Простое форматирование JS
          formatted = code
            .replace(/\s*\{\s*/g, ' {\n  ')
            .replace(/\s*\}\s*/g, '\n}\n')
            .replace(/\s*;\s*/g, ';\n')
            .replace(/\s*,\s*/g, ', ');
        }
        
        currentEditor.setValue(formatted);
        showNotification('Code formatted successfully', 'success');
      } catch (e) {
        showNotification('Error formatting code', 'error');
        console.error(e);
      }
    }

    // Сохранение файла
    function saveFile() {
      if (!currentEditor) return;
      
      const content = currentEditor.getValue();
      // Здесь должна быть логика сохранения файла
      console.log('Saving file:', content);
      showNotification('File saved successfully', 'success');
      showTooltip('File saved', currentEditor.getCursor().line);
    }

    // Переключение превью
    function togglePreview() {
      const previewPanel = document.getElementById('preview-panel');
      if (previewPanel.style.display === 'none') {
        previewPanel.style.display = 'flex';
        document.getElementById('toggle-preview').innerHTML = '<i class="fas fa-eye-slash"></i>';
        updatePreview();
      } else {
        previewPanel.style.display = 'none';
        document.getElementById('toggle-preview').innerHTML = '<i class="fas fa-eye"></i>';
      }
    }

    // Инициализация HTML редактора по умолчанию
    createEditor('html');

    // Управление окном
    const { ipcRenderer } = require('electron');
    
    document.getElementById('minimize-btn').addEventListener('click', () => {
      ipcRenderer.send('minimize-window');
    });
    
    document.getElementById('maximize-btn').addEventListener('click', () => {
      ipcRenderer.send('maximize-window');
    });
    
    document.getElementById('close-btn').addEventListener('click', () => {
      ipcRenderer.send('close-window');
    });

    // Переключение вкладок
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabName = tab.dataset.tab;
        switchEditor(tabName);
      });
      
      // Закрытие вкладки
      const closeBtn = tab.querySelector('.tab-close');
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        // Здесь должна быть логика закрытия вкладки
        console.log('Closing tab:', tab.dataset.tab);
        showNotification(`Closed tab: ${tab.dataset.tab}`, 'warning');
      });
    });

    // Выбор файлов в дереве
    const fileItems = document.querySelectorAll('.file-item');
    fileItems.forEach(item => {
      item.addEventListener('click', () => {
        fileItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        const fileType = item.dataset.file;
        document.querySelector(`.tab[data-tab="${fileType}"]`).click();
      });
    });

    // Кнопки превью
    document.getElementById('refresh-preview').addEventListener('click', updatePreview);
    document.getElementById('expand-preview').addEventListener('click', () => {
      const previewPanel = document.getElementById('preview-panel');
      if (previewPanel.style.width === '100%') {
        previewPanel.style.width = '400px';
      } else {
        previewPanel.style.width = '100%';
      }
    });
    document.getElementById('toggle-preview').addEventListener('click', togglePreview);

    // Поиск
    document.getElementById('search-input').addEventListener('input', (e) => {
      findText(e.target.value);
    });
    document.getElementById('search-prev').addEventListener('click', findPrev);
    document.getElementById('search-next').addEventListener('click', findNext);
    document.getElementById('search-close').addEventListener('click', toggleSearch);

    // Контекстное меню
    document.getElementById('ctx-copy').addEventListener('click', () => {
      if (currentEditor) {
        const selection = currentEditor.getSelection();
        navigator.clipboard.writeText(selection);
        showNotification('Copied to clipboard', 'success');
      }
    });
    document.getElementById('ctx-paste').addEventListener('click', async () => {
      if (currentEditor) {
        const text = await navigator.clipboard.readText();
        currentEditor.replaceSelection(text);
        showNotification('Pasted from clipboard', 'success');
      }
    });
    document.getElementById('ctx-format').addEventListener('click', formatCode);
    document.getElementById('ctx-search').addEventListener('click', toggleSearch);

    // Горячие клавиши
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveFile();
      }
      if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        toggleSearch();
      }
      if (e.key === 'Escape') {
        document.getElementById('search-box').classList.remove('show');
      }
    });

    // Инициализация превью
    updatePreview();
    showNotification('Editor initialized successfully', 'success');

    // Ресайзеры
    setupResizer('sidebar-resizer', 'sidebar', 'horizontal');
    setupResizer('preview-resizer', 'preview-panel', 'horizontal');

    function setupResizer(resizerId, panelId, direction) {
      const resizer = document.getElementById(resizerId);
      const panel = document.getElementById(panelId);
      let isResizing = false;
      let startX, startWidth;

      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = parseInt(document.defaultView.getComputedStyle(panel).width, 10);
        document.body.style.cursor = direction === 'horizontal' ? 'col-resize' : 'row-resize';
        document.addEventListener('mousemove', mouseMoveHandler);
        document.addEventListener('mouseup', mouseUpHandler);
        e.preventDefault();
      });

      function mouseMoveHandler(e) {
        if (!isResizing) return;
        
        const dx = e.clientX - startX;
        let newWidth;
        
        if (panelId === 'sidebar') {
          newWidth = Math.max(200, Math.min(startWidth + dx, 500));
          panel.style.width = `${newWidth}px`;
        } else {
          newWidth = Math.max(300, Math.min(startWidth - dx, 800));
          panel.style.width = `${newWidth}px`;
        }
      }

      function mouseUpHandler() {
        isResizing = false;
        document.body.style.cursor = '';
        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
      }
    }
  </script>
</body>
</html>